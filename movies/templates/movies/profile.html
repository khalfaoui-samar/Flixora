<!-- movies/templates/movies/profile.html -->
{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - Flixora</title>
    <link rel="stylesheet" href="{% static 'movies/css/styles.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<!-- Header avec navigation -->
<header class="profile-header">
    <div class="container">
        <a href="{% url 'movie_list' %}" class="logo">
            <i class="fas fa-film"></i>
            <span>Flixora</span>
        </a>
        
        <nav class="profile-nav">
            <a href="{% url 'movie_list' %}">
                <i class="fas fa-home"></i>
                Accueil
            </a>
            <a href="{% url 'profile' %}" class="active">
                <i class="fas fa-user"></i>
                Ma Flixora 
            </a>
            <a href="{% url 'watch_history' %}" class="history-link">
                <i class="fas fa-history"></i>
                Historique
            </a>
            <a href="{% url 'logout' %}" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                Déconnexion
            </a>
        </nav>
    </div>
</header>

<main class="profile-container">
    <!-- Section informations utilisateur -->
    <section class="user-info-section" >
        <div class="user-card" >
            <div class="user-avatar">
                {% if user.profile.avatar %}
                    <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}" id="currentAvatar">
                {% else %}
                    <div class="default-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                {% endif %}
                <button type="button" class="change-avatar-overlay" onclick="openAvatarModal()">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
            
            <div class="user-details">
                <h1>{{ user.username }}</h1>
                <p class="user-email">{{ user.email }}</p>

                 <!-- AJOUTEZ CETTE SECTION POUR LA BIO -->
    <div class="user-bio-section">
        <h3 class="bio-title">
            <i class="fas fa-quote-left"></i>
            À propos de moi
        </h3>
        <div class="bio-content">
            {% if user.profile.bio %}
                <p>{{ user.profile.bio|linebreaks }}</p>
            {% else %}
            <textarea id="bio" name="bio" class="form-textarea" 
            rows="4" placeholder="Décrivez-vous en quelques mots...">
      {{ user.profile.bio|default:'' }}
  </textarea>
                </p>
            {% endif %}
        </div>
    </div>

                
                <div class="user-stats">
                    <div class="stat">
                        <span class="stat-number">{{ favorite_count }}</span>
                        <span class="stat-label">Favoris</span>
                    </div>
                    <div class="stat">
                        <span class="stat-number">{{ watch_history_count|default:"0" }}</span>
                        <span class="stat-label">Visionnages</span>
                    </div>
                    <div class="stat">
                        <span class="stat-number">{{ user.date_joined|date:"d/m/Y" }}</span>
                        <span class="stat-label">Membre depuis</span>
                    </div>
                </div>
                
                <!-- Boutons d'actions utilisateur -->
                <div class="user-actions">
                    <button type="button" class="change-avatar-btn" onclick="openAvatarModal()">
                        <i class="fas fa-camera"></i>
                        Changer la photo
                    </button>
                    

                    <button type="button" class="edit-profile-btn" onclick="openEditProfileModal()">
                        <i class="fas fa-edit"></i>
                        Modifier profil
                    </button>

                </div>
            </div>
        </div>
    </section>

    <!-- Section films favoris -->
    <section class="favorites-section">
        <div class="section-header">
            <h2>
                <i class="fas fa-heart"></i>
                Mes Films Favoris
                <span class="badge">{{ favorite_count }}</span>
            </h2>
        </div>

        {% if favorite_movies %}
        <div class="favorites-grid">
            {% for movie in favorite_movies %}
            <div class="favorite-movie-card">
                <a href="{% url 'movie_detail' movie.pk %}" class="movie-link">
                    {% if movie.thumbnail %}
                        <img src="{{ movie.thumbnail.url }}" 
                             alt="{{ movie.title }}" 
                             class="movie-poster">
                    {% else %}
                        <img src="{% static 'movies/images/default-poster.jpg' %}" 
                             alt="{{ movie.title }}" 
                             class="movie-poster">
                    {% endif %}
                    
                    <div class="movie-info">
                        <h3 class="movie-title">{{ movie.title }}</h3>
                        <span class="movie-category">{{ movie.category }}</span>
                        
                        {% if movie.duration %}
                        <div class="movie-duration">
                            <i class="fas fa-clock"></i>
                            {{ movie.duration }} min
                        </div>
                        {% endif %}
                    </div>
                </a>
                
                <button class="remove-favorite" 
                        data-movie-id="{{ movie.pk }}"
                        onclick="removeFromFavorites({{ movie.pk }})">
                    <i class="fas fa-times"></i>
                    Retirer
                </button>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-favorites">
            <div class="empty-icon">
                <i class="far fa-heart"></i>
            </div>
            <h3>Aucun film favori</h3>
            <p>Ajoutez des films à vos favoris en cliquant sur le cœur ❤️</p>
            <a href="{% url 'movie_list' %}" class="browse-btn">
                <i class="fas fa-film"></i>
                Parcourir les films
            </a>
        </div>
        {% endif %}
    </section>
</main>

<!-- Modal pour changer la photo de profil -->
<div id="avatarModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>
                <i class="fas fa-camera"></i>
                Changer la photo de profil
            </h3>
            <button class="close-modal" onclick="closeAvatarModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="avatarForm" method="POST" action="{% url 'update_avatar' %}" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="avatar-preview-container">
                    <div class="avatar-preview" id="avatarPreview">
                        {% if user.profile.avatar %}
                            <img src="{{ user.profile.avatar.url }}" alt="Prévisualisation">
                        {% else %}
                            <div class="default-preview">
                                <i class="fas fa-user"></i>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="file-input-container">
                    <input type="file" id="avatarInput" name="avatar" accept="image/*" 
                           class="file-input" onchange="previewAvatar(event)">
                    <label for="avatarInput" class="file-input-label">
                        <i class="fas fa-upload"></i>
                        Choisir une image
                    </label>
                    <p class="file-info">Formats acceptés : JPG, PNG, GIF (max 5MB)</p>
                </div>
                
                <div class="avatar-options">
                    <p>Ou choisir un avatar par défaut :</p>
                    <div class="default-avatars">
                        <div class="default-avatar-option" onclick="selectDefaultAvatar('avatar1')">
                            <div class="avatar-icon male">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="avatar-label">Homme</span>
                        </div>
                        <div class="default-avatar-option" onclick="selectDefaultAvatar('avatar2')">
                            <div class="avatar-icon female">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="avatar-label">Femme</span>
                        </div>
                        <div class="default-avatar-option" onclick="selectDefaultAvatar('avatar3')">
                            <div class="avatar-icon neutral">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <span class="avatar-label">Neutre</span>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeAvatarModal()">
                        Annuler
                    </button>
                    <button type="submit" class="btn-save">
                        <i class="fas fa-save"></i>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour modifier le profil -->
<div id="editProfileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>
                <i class="fas fa-edit"></i>
                Modifier le profil
            </h3>
            <button class="close-modal" onclick="closeEditProfileModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="editProfileForm" method="POST" action="{% url 'update_profile' %}">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="username">
                        <i class="fas fa-user"></i>
                        Nom d'utilisateur
                    </label>
                    <input type="text" id="username" name="username" value="{{ user.username }}" 
                           class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label for="email">
                        <i class="fas fa-envelope"></i>
                        Email
                    </label>
                    <input type="email" id="email" name="email" value="{{ user.email }}" 
                           class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label for="bio">
                        <i class="fas fa-info-circle"></i>
                        Bio
                    </label>
                    <textarea id="bio" name="bio" class="form-textarea" 
                              rows="4" placeholder="Décrivez-vous en quelques mots...">
                        {{ user.profile.bio|default:'' }}
                    </textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditProfileModal()">
                        Annuler
                    </button>
                    <button type="submit" class="btn-save">
                        <i class="fas fa-save"></i>
                        Sauvegarder
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Fonction pour retirer un film des favoris
async function removeFromFavorites(movieId) {
    if (!confirm('Retirer ce film des favoris ?')) return;
    
    try {
        const response = await fetch(`/toggle-favorite/${movieId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Recharger la page pour mettre à jour la liste
            location.reload();
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Une erreur est survenue');
    }
}

// Fonctions pour la modal d'avatar
function openAvatarModal() {
    document.getElementById('avatarModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeAvatarModal() {
    document.getElementById('avatarModal').classList.remove('show');
    document.body.style.overflow = 'auto';
}

function previewAvatar(event) {
    const input = event.target;
    const preview = document.getElementById('avatarPreview');
    
    if (input.files && input.files[0]) {
        // Vérifier la taille du fichier (max 5MB)
        if (input.files[0].size > 5 * 1024 * 1024) {
            alert('Le fichier est trop volumineux. Taille maximum : 5MB');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" alt="Prévisualisation">`;
        }
        
        reader.readAsDataURL(input.files[0]);
    }
}

function selectDefaultAvatar(type) {
    const preview = document.getElementById('avatarPreview');
    let iconClass = 'fas fa-user';
    let colorClass = 'male';
    let avatarValue = '';
    
    switch(type) {
        case 'avatar1':
            iconClass = 'fas fa-user';
            colorClass = 'male';
            avatarValue = 'male';
            break;
        case 'avatar2':
            iconClass = 'fas fa-user';
            colorClass = 'female';
            avatarValue = 'female';
            break;
        case 'avatar3':
            iconClass = 'fas fa-user-tie';
            colorClass = 'neutral';
            avatarValue = 'neutral';
            break;
    }
    
    preview.innerHTML = `
        <div class="avatar-icon ${colorClass}">
            <i class="${iconClass}"></i>
        </div>
    `;
    
    // Créer un champ caché pour l'avatar par défaut
    let hiddenInput = document.getElementById('defaultAvatar');
    if (!hiddenInput) {
        hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'default_avatar';
        hiddenInput.id = 'defaultAvatar';
        document.getElementById('avatarForm').appendChild(hiddenInput);
    }
    hiddenInput.value = avatarValue;
    
    // Réinitialiser le champ fichier
    document.getElementById('avatarInput').value = '';
}

// Fonctions pour la modal d'édition de profil
function openEditProfileModal() {
    document.getElementById('editProfileModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeEditProfileModal() {
    document.getElementById('editProfileModal').classList.remove('show');
    document.body.style.overflow = 'auto';
}

// Fermer les modals en cliquant en dehors
document.addEventListener('DOMContentLoaded', function() {
    const modals = document.querySelectorAll('.modal');
    
    modals.forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                if (this.id === 'avatarModal') {
                    closeAvatarModal();
                } else if (this.id === 'editProfileModal') {
                    closeEditProfileModal();
                }
            }
        });
    });
    
    // Fermer avec la touche Échap
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAvatarModal();
            closeEditProfileModal();
        }
    });
    
    // Soumission du formulaire d'avatar
    const avatarForm = document.getElementById('avatarForm');
    if (avatarForm) {
        avatarForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Mettre à jour l'avatar affiché
                    const currentAvatar = document.getElementById('currentAvatar');
                    if (currentAvatar && data.avatar_url) {
                        currentAvatar.src = data.avatar_url;
                    }
                    
                    // Afficher une notification
                    showNotification('Photo de profil mise à jour avec succès !', 'success');
                    
                    // Fermer la modal
                    closeAvatarModal();
                    
                    // Rafraîchir après 1 seconde
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification(data.error || 'Erreur lors de la mise à jour', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Une erreur est survenue', 'error');
            }
        });
    }
    
    // Soumission du formulaire d'édition de profil
    const editProfileForm = document.getElementById('editProfileForm');
    if (editProfileForm) {
        editProfileForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Profil mis à jour avec succès !', 'success');
                    closeEditProfileModal();
                    
                    // Rafraîchir les infos après 1 seconde
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification(data.error || 'Erreur lors de la mise à jour', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Une erreur est survenue', 'error');
            }
        });
    }
});

// Fonction pour afficher des notifications
function showNotification(message, type = 'info') {
    // Créer la notification
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    // Ajouter au body
    document.body.appendChild(notification);
    
    // Supprimer après 5 secondes
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 5000);
}
</script>

</body>
</html>